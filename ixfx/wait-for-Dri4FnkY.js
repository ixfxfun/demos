import{F as e,m as t,n}from"./src-DdJCbM4z.js";import{a as r,u as i,y as a}from"./numbers-BlBexQl9.js";import{i as o}from"./logger-o11drWM0.js";import{t as s}from"./error-message-CFnyH0EB.js";import{t as c}from"./timeout-BnV_k5ts.js";const l=(e,t)=>{let n=c(e,t);return(...e)=>{n.start(void 0,e)}},u=(e,t,n={})=>{let r=n.timeoutMs??601e3,i=n.signal,a=!1,o=!1,s;return new Promise((n,c)=>{let l=e=>{`type`in e?t.includes(e.type)?(a=!0,n(e),u()):console.warn(`eventRace: Got event '${e.type}' that is not in race list`):(console.warn(`eventRace: Event data does not have expected 'type' field`),console.log(e))};for(let n of t)e.addEventListener(n,l);let u=()=>{if(!o){s!==void 0&&clearTimeout(s),s=void 0,o=!0;for(let n of t)e.removeEventListener(n,l)}};s=setTimeout(()=>{a||o||(u(),c(Error(`eventRace: Events not fired within interval. Events: ${JSON.stringify(t)} Interval: ${r}`)))},r),i?.addEventListener(`abort`,()=>{a||o||(u(),c(Error(`Abort signal received ${i.reason}`)))})})};function*d(e={}){let t=e.startAt??1,n=e.limitAttempts??2**53-1,o=e.limitValue,s=e.power??1.1,c=t;for(a(r(n,`aboveZero`,`limitAttempts`),i(t,``,`startAt`),i(n,``,`limitAttempts`),()=>o===void 0?void 0:i(o,``,`limitValue`),i(s,``,`power`));n>0;){if(o&&c>=o)return;n--,yield c,c+=c**+s}}const f=(e,t={})=>p({async probe(){try{let n=await e();return n===void 0?{value:t.taskValueFallback,error:`Fallback`,success:!1}:{value:n,success:!0}}catch(e){return{success:!1,error:e}}}},t),p=async(r,i={})=>{let a=i.abort,c=o(i.log),l=i.predelayMs??0,u=e(),f=0,p=i.startAt??1e3,m=i.limitAttempts??2**53-1,h=d({...i,startAt:p,limitAttempts:m});if(p<=0)throw Error(`Param 'initialValue' must be above zero`);if(l>0)try{await n({millis:l,signal:a})}catch(e){return{success:!1,attempts:f,value:i.taskValueFallback,elapsed:u(),message:s(e)}}for(let e of h){f++;let o=await r.probe(f);if(o.success)return{success:o.success,value:o.value,attempts:f,elapsed:u()};if(c({msg:`retry attempts: ${f.toString()} t: ${t(e)}`}),f>=m)break;try{await n({millis:e,signal:a})}catch(e){return{success:!1,attempts:f,value:i.taskValueFallback,message:s(e),elapsed:u()}}}return{message:`Giving up after ${f.toString()} attempts.`,success:!1,attempts:f,value:i.taskValueFallback,elapsed:u()}},m=(e,t,n)=>{let r,i=!1;return r=globalThis.setTimeout(()=>{r=void 0;try{t(`Timeout after ${e}ms`)}finally{n!==void 0&&n(i)}},e),e=>{r!==void 0&&(window.clearTimeout(r),r=void 0),e?t(e):i=!0,n!==void 0&&n(i)}};export{u as a,p as i,d as n,l as o,f as r,m as t};